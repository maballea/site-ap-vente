{% extends 'base.html.twig' %}

{% block title %}Catalogue{% endblock %}

{% block body %}
<div class="container mt-4">
    <h1 class="text-center mb-4">Catalogue</h1>

    <!-- Affichage du nombre d'objets dans le panier -->
    {% if is_granted('ROLE_CLIENT') and not is_granted('ROLE_ADMIN') %}
    <div id="panier-quantite" class="alert alert-info d-inline-block">
        <span>Articles dans le panier: </span><span id="quantite-panier" class="fw-bold">0</span>
    </div>
    {% endif %}


    <!-- Formulaire de tri des produits -->
    <form method="GET" action="{{ path('produit_catalogue') }}" class="mb-3 d-flex align-items-center">
        <label for="tri" class="me-2">Trier les produits par :</label>
        <select name="tri" id="tri" class="form-select w-auto me-3" onchange="this.form.submit()">
            <option value="nom" {% if app.request.get('tri') == 'nom' %}selected{% endif %}>Nom (A-Z)</option>
            <option value="nom_desc" {% if app.request.get('tri') == 'nom_desc' %}selected{% endif %}>Nom (Z-A)</option>
            <option value="prix" {% if app.request.get('tri') == 'prix' %}selected{% endif %}>Prix croissant</option>
            <option value="prix_desc" {% if app.request.get('tri') == 'prix_desc' %}selected{% endif %}>Prix décroissant</option>
        </select>
    </form>

    <!-- Formulaire de tri des catégories -->
    <form method="GET" action="{{ path('produit_catalogue') }}" class="mb-3 d-flex align-items-center">
        <label for="tri_categories" class="me-2">Trier les catégories par :</label>
        <select name="tri_categories" id="tri_categories" class="form-select w-auto" onchange="this.form.submit()">
            <option value="categorie_asc" {% if app.request.get('tri_categories') == 'categorie_asc' %}selected{% endif %}>Nom (A-Z)</option>
            <option value="categorie_desc" {% if app.request.get('tri_categories') == 'categorie_desc' %}selected{% endif %}>Nom (Z-A)</option>
        </select>
    </form>

    {% for categorie, produits in produitsParCategorie %}
        <div class="mb-4">
            <h2 class="text-primary">{{ categorie }}</h2>

            {% if produits is empty %}
                <p class="text-muted">Aucun produit dans cette catégorie.</p>
                
            {% else %}
                <table class="table table-striped table-hover">
                    <thead class="table-dark">
                        <tr>
                            <th>Nom</th>
                            <th>Description</th>
                            <th>Prix unitaire</th>
                            {% if is_granted('ROLE_ADMIN') %}
                                <th>Actions</th>
                            {% elseif is_granted('ROLE_CLIENT') %}
                                <th>Ajouter au panier</th>
                            {% endif %}
                        </tr>
                    </thead>
                    <tbody>
                        {% for produit in produits %}
                            <tr>
                                <td>{{ produit.nom }}</td>
                                <td>{{ produit.description }}</td>
                                <td>{{ produit.prix }} €</td>
                                
                                {% if is_granted('ROLE_ADMIN') %}
                                    <td>
                                        <a href="{{ path('produit_edit', { id: produit.id }) }}" class="btn btn-warning btn-sm">Modifier</a>
                                        <a href="{{ path('produit_delete', { id: produit.id }) }}" class="btn btn-danger btn-sm"
                                           onclick="return confirm('Êtes-vous sûr de vouloir supprimer ce produit ?');">Supprimer</a>
                                    </td>
                                {% elseif is_granted('ROLE_CLIENT') %}
                                    <td>
                                        <form action="{{ path('panier_ajouter', { id: produit.id }) }}" method="post" class="d-flex align-items-center">
                                            <input type="number" name="quantite" min="1" value="1" class="form-control me-2" style="width: 80px;">
                                            <button type="submit" class="btn btn-primary btn-sm">Ajouter</button>
                                        </form>
                                    </td>
                                {% endif %}
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            {% endif %}
        </div>
    {% endfor %}



    <script>
        // Fonction pour mettre à jour la quantité du panier
        function updatePanierQuantite() {
            fetch('{{ path('panier_quantite') }}')
                .then(response => response.json())
                .then(data => {
                    document.getElementById('quantite-panier').textContent = data.quantite;
                });
        }

        // Mettre à jour après chaque ajout au panier
        document.querySelectorAll('.btn-ajouter-panier').forEach(button => {
            button.addEventListener('click', function() {
                updatePanierQuantite();
            });
        });

        // Initialisation de la quantité au chargement de la page
        updatePanierQuantite();
    </script>

    <div class="mt-4">
        {% if is_granted('ROLE_ADMIN') %}
            <a href="{{ path('produit_new') }}" class="btn btn-success">Ajouter un produit</a>
            <a href="{{ path('categorie_index') }}" class="btn btn-success">Ajouter / Modifier les catégories</a>

        {% endif %}
        <div class="mt-3">
            {% if is_granted('ROLE_ADMIN') %}
                <button type="button" onclick="window.location.href='{{ path('admin_acceuil') }}'" class="btn btn-secondary">Accueil</button>
            {% elseif is_granted('ROLE_CLIENT') %}
                <button type="button" onclick="window.location.href='{{ path('client_acceuil') }}'" class="btn btn-secondary">Accueil</button>
                <button type="button" onclick="window.location.href='{{ path('panier') }}'" class="btn btn-secondary">Voir le Panier</button>
            {% else %}
                <button type="button" onclick="window.location.href='{{ path('app_user') }}'" class="btn btn-secondary">Accueil</button>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}
